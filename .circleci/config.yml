version: 2.1

commands:
  build_and_push_base_image:
    parameters:
      dockerfile:
        type: string
      tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Docker registry login
          command: echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin $DOCKER_SERVER
      - run:
          name: Build base image
          command: |
            cd docker/btcpool/base-image && \
            docker build --rm -t $DOCKER_SERVER/$BASE_IMAGE_REPO:<<parameters.tag>> -f <<parameters.dockerfile>> .
      - run:
          name: Push base image
          command: docker push $DOCKER_SERVER/$BASE_IMAGE_REPO:<<parameters.tag>>
  build_and_run_unit_tests_single_chain:
    steps:
      - checkout
      - run:
          name: Run CMake
          command: |
            mkdir build && cd build && \
            cmake -DCMAKE_BUILD_TYPE=Debug -DCHAIN_SRC_ROOT=/work/bitcoin -DCHAIN_TYPE=$CHAIN_TYPE -DJOBS=2  ..
      - run:
          name: Build btcpool
          command: cd build && make -j2
      - run:
          name: Run unit tests
          command: cd build && make test

jobs:
  build_and_push_base_image_lint:
    docker:
      - image: circleci/golang
    steps:
      - build_and_push_base_image:
          dockerfile: Dockerfile.lint
          tag: lint
  check_clang_format:
    docker:
      - image: $DOCKER_SERVER/$BASE_IMAGE_REPO:lint
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - checkout
      - run:
          name: Run clang-format
          command: ./run-clang-format.sh && git diff --exit-code
  build_and_run_unit_tests_bch:
    docker:
      - image: $DOCKER_SERVER/$BASE_IMAGE_REPO:bch-0.18.5
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - build_and_run_unit_tests_single_chain
  build_and_run_unit_tests_btc:
    docker:
      - image: $DOCKER_SERVER/$BASE_IMAGE_REPO:btc-0.16.3
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - build_and_run_unit_tests_single_chain
  build_and_run_unit_tests_sbtc:
    docker:
      - image: $DOCKER_SERVER/$BASE_IMAGE_REPO:sbtc-0.16.2
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - build_and_run_unit_tests_single_chain
  build_and_run_unit_tests_ubtc:
    docker:
      - image: $DOCKER_SERVER/$BASE_IMAGE_REPO:ubtc-2.3.0.1
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - build_and_run_unit_tests_single_chain

workflows:
  version: 2
  build_and_push_base_images:
    jobs:
      - build_and_push_base_image_lint:
          filters:
            tags:
              only: /.*base-image.*/
            branches:
              ignore: /.*/
  build_and_run_unit_tests_all_chains:
    jobs:
      - check_clang_format
      - build_and_run_unit_tests_bch:
          requires:
            - check_clang_format
      - build_and_run_unit_tests_btc:
          requires:
            - check_clang_format
      - build_and_run_unit_tests_sbtc:
          requires:
            - check_clang_format
      - build_and_run_unit_tests_ubtc:
          requires:
            - check_clang_format
